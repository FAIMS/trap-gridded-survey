<?xml version="1.0" encoding="utf-8"?>
<!--@POSTPROC: ./postproc.sh -->
<module suppressWarnings="true">

<Login f="nodata">
  <Login f="noscroll">
    <User_Name t="list" f="user" l="Control"/>
  </Login>
</Login>

<Control f="nodata">
  <Main>
    <Add_New_Walker t="button" l="Walker"/>
    <!--TODO: Add a helper to the autogen which allows saving of these in localsettings-->
    <Number_of_Rows    b="decimal"/>
    <Number_of_Walkers b="decimal"/>
  </Main>
  <search/>
</Control>

<!--Walker: Texas Ranger-->
<Walker>
  <Walker>
    <Grid t="webview" f="nolabel"/>
    <cols>
      <group_tl t="group"/>
      <Up       t="button"/>
      <group_tr t="group"/>
    </cols>
    <cols>
      <Left     t="button"/>
      <Load     t="button"/>
      <Right    t="button"/>
    </cols>
    <cols>
      <group_bl t="group"/>
      <Down     t="button"/>
      <group_br t="group"/>
    </cols>
    <cols>
      <Row_ID    f="id"/>
      <Walker_ID f="id"/>
      <Property_1/>
    </cols>
  </Walker>

  <Vars f="hidden">
    <Number_of_Rows     f="nodata"/>
    <Number_of_Walkers  f="nodata"/>
    <Highlighted_Row    f="nodata"/>
    <Highlighted_Walker f="nodata"/>
  </Vars>
</Walker>

<logic><![CDATA[
  getGridHtml(
      Integer numberOfRows,   Integer numberOfWalkers,
      Integer highlightedRow, Integer highlightedWalker,
      Integer selectedRow,    Integer selectedWalker
  ) {
    // In a probably vain attempt to improve performance, this code is valid
    // HTML5.
    String html = "";

    html += "<!DOCTYPE html>";
    html += "<html>";
    html += "  <head>";
    html += "    <title>Grid</title>";
    html += "    <style>";
    html += "      table {";
    html += "        width: 100%;";
    html += "        border-collapse: collapse;";
    html += "      }";
    html += "      td {";
    html += "        background-color: #FFFFFF;";
    html += "        border: 1px solid #000000;";
    html += "      }";
    html += "      td.highlighted {";
    html += "        background-color: #DDDDDD !important;";
    html += "        color:            #000000 !important;";
    html += "      }";
    html += "      td.selected {";
    html += "        background-color: #000000;";
    html += "        color:            #FFFFFF;";
    html += "      }";
    html += "    </style>";
    html += "  </head>";
    html += "  <table>";

    for (i = 1; i <= numberOfRows; i++) {
      html += "<tr>";
      for (j = 1; j <= numberOfWalkers; j++) {
        Boolean isHighlighted = (i == highlightedRow && j == highlightedWalker);
        Boolean isSelected    = (i == selectedRow    && j == selectedWalker);

        String  cssClass = "";
        if (isHighlighted) cssClass += " highlighted";
        if (isSelected)    cssClass += " selected";

        String htmlRow = "";
        htmlRow += "<td class=\"{cssClass}\">";
        htmlRow += "Row {row}, Walker {walker}";
        htmlRow += "</td>";
        htmlRow  = replaceFirst(htmlRow, "{cssClass}", cssClass);
        htmlRow  = replaceFirst(htmlRow, "{row}",      i);
        htmlRow  = replaceFirst(htmlRow, "{walker}",   j);

        html += htmlRow;
      }
      html += "</tr>";
    }
    html += "  </table>";
    html += "</html>";

    return html;
  }

  getFieldValueAsInteger(String ref) {
    String  val          = getFieldValue(ref);
    Integer valAsInteger = 0;

    try {
      valAsInteger = Integer.valueOf(val);
    } catch (Exception e) { ; }

    return valAsInteger;
  }

  clip(Integer x, Integer min, Integer max) {
    if (x > max) return max;
    if (x < min) return min;
    return x;
  }

  numberOfRows() {
    String ref = "Walker/Vars/Number_of_Rows";
    return getFieldValueAsInteger(ref);
  }

  highlightedRow() {
    String  ref = "Walker/Vars/Highlighted_Row";
    Integer val = getFieldValueAsInteger(ref);

    return clip(val, 1, numberOfRows());
  }

  highlightedRow(Integer val) {
    val = clip(val, 1, numberOfRows());

    String ref = "Walker/Vars/Highlighted_Row";
    setFieldValue(ref, val.toString());
  }

  selectedRow() {
    String ref = "Walker/Walker/Row_ID";
    return getFieldValueAsInteger(ref);
  }

  numberOfWalkers() {
    String ref = "Walker/Vars/Number_of_Walkers";
    return getFieldValueAsInteger(ref);
  }

  highlightedWalker() {
    String  ref = "Walker/Vars/Highlighted_Walker";
    Integer val = getFieldValueAsInteger(ref);

    return clip(val, 1, numberOfWalkers());
  }

  highlightedWalker(Integer val) {
    val = clip(val, 1, numberOfWalkers());

    String ref = "Walker/Vars/Highlighted_Walker";
    setFieldValue(ref, val.toString());
  }

  selectedWalker() {
    String ref = "Walker/Walker/Walker_ID";
    return getFieldValueAsInteger(ref);
  }

  moveWalker(Integer delta) {
    highlightedWalker(highlightedWalker() + delta);
  }

  moveRow(Integer delta) {
    highlightedRow(highlightedRow() + delta);
  }

  redrawGrid() {
    String ref  = "Walker/Walker/Grid";
    String html = getGridHtml(
        numberOfRows(),   numberOfWalkers(),
        highlightedRow(), highlightedWalker(),
        selectedRow(),    selectedWalker()
    );
    populateWebViewHtml(ref, html);
  }

  gridUp()    { moveRow   (-1); redrawGrid(); }
  gridDown()  { moveRow   (+1); redrawGrid(); }
  gridLeft()  { moveWalker(-1); redrawGrid(); }
  gridRight() { moveWalker(+1); redrawGrid(); }

  onCreateWalker() {
    copyFieldValue(
      "Control/Main/Number_of_Rows",
      "Walker/Vars/Number_of_Rows",
      false
    );
    copyFieldValue(
      "Control/Main/Number_of_Walkers",
      "Walker/Vars/Number_of_Walkers",
      false
    );
  }

  // TODO: Make loading/creating work properly. We have to handle two cases:
  //   1) A Walker entity has not been created yet.
  //   2) A Walker entity has already been created.
  showStuff() {
    showTabGroup("Walker");
  }

  addOnEvent("Walker/Walker",       "show",  "redrawGrid()");
  addOnEvent("Walker/Walker/Up",    "click", "gridUp    ()");
  addOnEvent("Walker/Walker/Down",  "click", "gridDown  ()");
  addOnEvent("Walker/Walker/Left",  "click", "gridLeft  ()");
  addOnEvent("Walker/Walker/Right", "click", "gridRight ()");
  addOnEvent("Walker/Walker/Load",  "click", "showStuff ()");
]]></logic>

</module>
